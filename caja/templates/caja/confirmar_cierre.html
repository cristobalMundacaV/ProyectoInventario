{% extends 'base.html' %}
{% load format_numbers tz %}

{% block title %}Confirmar Cierre de Caja{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow border-0">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-lock-fill"></i>
                        Confirmar Cierre de Caja
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>¡Atención!</strong> Está a punto de cerrar la(s) caja(s). Esta acción no se puede deshacer.
                    </div>

                    {% for caja_data in cajas_datos %}
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                Caja {{ caja_data.caja.id }} - {{ caja_data.caja.fecha|date:"d/m/Y" }}
                                <span class="badge bg-warning text-dark">Abierta</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6>Información General</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Fecha:</strong></td>
                                            <td>{{ caja_data.caja.fecha|date:"d/m/Y" }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Apertura:</strong></td>
                                            <td>{{ caja_data.caja.hora_apertura|localtime|date:"H:i" }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Monto Inicial:</strong></td>
                                            <td>${{ caja_data.caja.monto_inicial|format_decimal:2 }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Cantidad de Ventas:</strong></td>
                                            <td>{{ caja_data.cantidad_ventas }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Abonos de Fiado:</strong></td>
                                            <td>{{ caja_data.cantidad_abonos_fiado|default:0 }}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Resumen de Ventas</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Total Vendido:</strong></td>
                                            <td class="text-success fw-bold">${{ caja_data.total_vendido|format_decimal:2 }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Efectivo:</strong></td>
                                            <td>${{ caja_data.total_efectivo|format_decimal:2 }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tarjeta:</strong></td>
                                            <td>${{ caja_data.total_tarjeta|format_decimal:2 }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Transferencia:</strong></td>
                                            <td>${{ caja_data.total_transferencia|format_decimal:2 }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total Abonos Fiado:</strong></td>
                                            <td>${{ caja_data.total_abonos_fiado|default:0|format_decimal:2 }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Ganancia:</strong></td>
                                            <td class="text-info fw-bold">${{ caja_data.ganancia|format_decimal:2 }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            {% if caja_data.ventas %}
                            <div class="row">
                                <div class="col-12">
                                    {% if caja_data.ventas_por_categoria and caja_data.ventas_por_categoria.items %}
                                    <h6 class="mt-2">Ventas por categoría <span class="text-muted small">(% sobre ventas)</span></h6>
                                    <div class="table-responsive mb-3">
                                        <table class="table table-sm table-hover align-middle">
                                            <thead>
                                                <tr>
                                                    <th>Categoría</th>
                                                    <th class="text-end">Total</th>
                                                    <th class="text-end">%</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for row in caja_data.ventas_por_categoria.items %}
                                                <tr>
                                                    <td>{{ row.categoria }}</td>
                                                    <td class="text-end">${{ row.total|format_decimal:2 }}</td>
                                                    <td class="text-end">{{ row.pct|floatformat:2 }}%</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            <tfoot>
                                                <tr class="table-light">
                                                    <td><strong>Total ventas</strong></td>
                                                    <td class="text-end"><strong>${{ caja_data.ventas_por_categoria.total|format_decimal:2 }}</strong></td>
                                                    <td class="text-end"><strong>100.00%</strong></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    {% endif %}
                                    <h6>Últimas Ventas ({{ caja_data.ventas|length }} de {{ caja_data.cantidad_ventas }})</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Hora</th>
                                                    <th>Usuario</th>
                                                    <th>Método</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for venta in caja_data.ventas %}
                                                <tr>
                                                    <td>{{ venta.id }}</td>
                                                    <td>{{ venta.fecha|localtime|date:"H:i" }}</td>
                                                    <td>{{ venta.usuario.username }}</td>
                                                    <td>{{ venta.get_metodo_pago_display }}</td>
                                                    <td>${{ venta.total|format_decimal:2 }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% if caja_data.cantidad_ventas > 5 %}
                                    <p class="text-muted small mb-0">
                                        <i class="bi bi-info-circle"></i>
                                        Mostrando las últimas 5 ventas de {{ caja_data.cantidad_ventas }} totales
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                No hay ventas registradas en esta caja.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}

                    <form method="post" action="{% url 'cerrar_caja' %}">
                        {% csrf_token %}
                        {% if next %}
                        <input type="hidden" name="next" value="{{ next }}">
                        {% endif %}
                        <div class="d-flex justify-content-between">
                            {% if next %}
                            <a href="{{ next }}" class="btn btn-secondary" style="border-radius: 999px;">
                                <i class="bi bi-arrow-left"></i> Volver
                            </a>
                            {% else %}
                            <a href="{% url 'caja_list' %}" class="btn btn-secondary" style="border-radius: 999px;">
                                <i class="bi bi-arrow-left"></i> Volver
                            </a>
                            {% endif %}
                            <button type="submit" class="btn btn-danger" style="border-radius: 999px;">
                                <i class="bi bi-lock-fill"></i> Confirmar Cierre de Caja
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
