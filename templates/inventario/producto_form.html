{% extends 'base.html' %}
{% block titulo %}{{ accion }} Producto{% endblock %}
{% block contenido %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-7">
        <div class="card shadow border-0">
            <div class="card-header bg-primary text-white fw-bold">
                <i class="bi bi-box"></i> {{ accion }} Producto
            </div>
            <div class="card-body">
                <form method="post" autocomplete="off" id="productoForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-7">
                            {% for field in form %}
                                {% if field.name == 'precio_compra' %}
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">{{ field.label }}{% if field.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                        {{ field }}
                                        {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                        {% for error in field.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    <div class="mb-3" id="field-unidades_por_pack" style="display:none;">
                                        <label class="form-label fw-semibold">{{ form.unidades_por_pack.label }}{% if form.unidades_por_pack.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                        {{ form.unidades_por_pack }}
                                        {% if form.unidades_por_pack.help_text %}<div class="form-text">{{ form.unidades_por_pack.help_text }}</div>{% endif %}
                                        {% for error in form.unidades_por_pack.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    <div class="mb-3" id="field-kg_por_caja" style="display:none;">
                                        <label class="form-label fw-semibold">{{ form.kg_por_caja.label }}{% if form.kg_por_caja.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                        {{ form.kg_por_caja }}
                                        {% if form.kg_por_caja.help_text %}<div class="form-text">{{ form.kg_por_caja.help_text }}</div>{% endif %}
                                        {% for error in form.kg_por_caja.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% elif field.name == 'precio_venta' %}
                                    {# Lo movemos al final, después del margen y antes de activo #}
                                {% elif field.name == 'unidades_por_pack' or field.name == 'kg_por_caja' %}
                                    {# Ya se muestran después de precio_compra, no aquí #}
                                {% elif field.name == 'activo' %}
                                    {# Lo movemos después de precio_venta #}
                                {% else %}
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">{{ field.label }}{% if field.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                        {{ field }}
                                        {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                                        {% for error in field.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                            <div id="precio-venta-container" class="mb-3">
                                <label class="form-label fw-semibold">{{ form.precio_venta.label }}{% if form.precio_venta.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                                {{ form.precio_venta }}
                                {% if form.precio_venta.help_text %}<div class="form-text">{{ form.precio_venta.help_text }}</div>{% endif %}
                                {% for error in form.precio_venta.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div id="activo-container" class="mb-3">
                                <label class="form-label fw-semibold">{{ form.activo.label }}</label>
                                {{ form.activo }}
                                {% if form.activo.help_text %}<div class="form-text">{{ form.activo.help_text }}</div>{% endif %}
                                {% for error in form.activo.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="mb-3" id="precio-unitario-pack-container" style="display:none;">
                                <label class="form-label fw-semibold">Precio unitario por pack:</label>
                                <div id="precio-unitario-pack" class="form-control bg-light"></div>
                            </div>
                            <div class="mb-3" id="precio-kg-granel-container" style="display:none;">
                                <label class="form-label fw-semibold">Precio costo por kg:</label>
                                <div id="precio-kg-granel" class="form-control bg-light"></div>
                            </div>
                            <div class="mb-3" id="margen-pack-container" style="display:none;">
                                <label class="form-label fw-semibold">Margen unitario (Pack):</label>
                                <div id="margen-pack" class="form-control bg-light"></div>
                            </div>
                            <div class="mb-3" id="margen-granel-container" style="display:none;">
                                <label class="form-label fw-semibold">Margen unitario (Granel):</label>
                                <div id="margen-granel" class="form-control bg-light"></div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="submit" class="btn btn-success shadow"><i class="bi bi-check-circle"></i> Guardar</button>
                        <a href="{% url 'producto_list' %}" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Cancelar</a>
                    </div>
                </form>
                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    function toggleFields() {
                        var tipo = document.getElementById('id_tipo_producto').value;
                        document.getElementById('field-unidades_por_pack').style.display = (tipo === 'PACK') ? 'block' : 'none';
                        document.getElementById('field-kg_por_caja').style.display = (tipo === 'GRANEL') ? 'block' : 'none';
                        document.getElementById('precio-unitario-pack-container').style.display = (tipo === 'PACK') ? 'block' : 'none';
                        document.getElementById('precio-kg-granel-container').style.display = (tipo === 'GRANEL') ? 'block' : 'none';
                        document.getElementById('margen-pack-container').style.display = (tipo === 'PACK') ? 'block' : 'none';
                        document.getElementById('margen-granel-container').style.display = (tipo === 'GRANEL') ? 'block' : 'none';
                        calcularValores();
                    }
                    function calcularValores() {
                        var tipo = document.getElementById('id_tipo_producto').value;
                        var precioCompra = parseFloat(document.getElementById('id_precio_compra').value.replace(',', '.')) || 0;
                        var precioVenta = parseFloat(document.getElementById('id_precio_venta').value.replace(',', '.')) || 0;
                        var unidadesPorPack = parseInt(document.getElementById('id_unidades_por_pack').value) || 0;
                        var kgPorCaja = parseFloat(document.getElementById('id_kg_por_caja').value.replace(',', '.')) || 0;

                        // PACK
                        var precioUnitario = '';
                        var margenPack = '';
                        if (tipo === 'PACK' && unidadesPorPack > 0) {
                            precioUnitario = (precioCompra / unidadesPorPack).toFixed(2);
                            margenPack = (precioVenta - (precioCompra / unidadesPorPack)).toFixed(2);
                        }
                        document.getElementById('precio-unitario-pack').textContent = precioUnitario ? ('$' + precioUnitario) : '';
                        document.getElementById('margen-pack').textContent = margenPack ? ('$' + margenPack) : '';

                        // GRANEL
                        var precioKgGranel = '';
                        var margenGranel = '';
                        if (tipo === 'GRANEL' && kgPorCaja > 0) {
                            precioKgGranel = (precioCompra / kgPorCaja).toFixed(2);
                            margenGranel = (precioVenta - (precioCompra / kgPorCaja)).toFixed(2);
                        }
                        document.getElementById('precio-kg-granel').textContent = precioKgGranel ? ('$' + precioKgGranel) : '';
                        document.getElementById('margen-granel').textContent = margenGranel ? ('$' + margenGranel) : '';
                    }
                    var tipoSelect = document.getElementById('id_tipo_producto');
                    var precioCompraInput = document.getElementById('id_precio_compra');
                    var precioVentaInput = document.getElementById('id_precio_venta');
                    var unidadesPorPackInput = document.getElementById('id_unidades_por_pack');
                    var kgPorCajaInput = document.getElementById('id_kg_por_caja');
                    if (tipoSelect) {
                        tipoSelect.addEventListener('change', toggleFields);
                        toggleFields();
                    }
                    if (precioCompraInput) {
                        precioCompraInput.addEventListener('input', calcularValores);
                    }
                    if (precioVentaInput) {
                        precioVentaInput.addEventListener('input', calcularValores);
                    }
                    if (unidadesPorPackInput) {
                        unidadesPorPackInput.addEventListener('input', calcularValores);
                    }
                    if (kgPorCajaInput) {
                        kgPorCajaInput.addEventListener('input', calcularValores);
                    }
                });
                </script>
            </div>
        </div>
    </div>
</div>
{% endblock %}
