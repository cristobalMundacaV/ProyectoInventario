{% extends 'base.html' %}
{% load format_numbers tz %}

{% block titulo %}Venta creada{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Venta creada correctamente</h5>
        </div>
        <div class="card-body">
            <p>Venta <strong>#{{ venta.id }}</strong> creada con éxito.</p>

            <div class="mb-3">
                <div class="table-responsive">
                    <table class="table table-sm small" style="font-size:13px;">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-center">Precio</th>
                                <th class="text-center">Subtotal</th>
                                <th class="text-center">Fecha</th>
                                <th class="text-center">Método</th>
                                <th class="text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for d in venta.detalles.all %}
                            <tr>
                                <td class="text-center">{{ d.producto }}</td>
                                <td class="text-center">{{ d.cantidad_ingresada|format_decimal:3 }}</td>
                                <td class="text-center">${{ d.precio_unitario|format_decimal:2 }}</td>
                                <td class="text-center">${{ d.subtotal|format_decimal:2 }}</td>
                                {% if forloop.first %}
                                <td class="text-center">{{ venta.fecha|localtime|date:"d/m/Y H:i" }}</td>
                                <td class="text-center">{{ venta.get_metodo_pago_display }}</td>
                                <td class="text-center">${{ venta.total|format_money }}</td>
                                {% else %}
                                <td></td>
                                <td></td>
                                <td></td>
                                {% endif %}
                            </tr>
                            {% empty %}
                            <tr>
                                <td class="text-center">-</td>
                                <td class="text-center">-</td>
                                <td class="text-center">-</td>
                                <td class="text-center">-</td>
                                <td class="text-center">{{ venta.fecha|localtime|date:"d/m/Y H:i" }}</td>
                                <td class="text-center">{{ venta.get_metodo_pago_display }}</td>
                                <td class="text-center">${{ venta.total|format_money }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button id="btn-print" class="btn btn-primary">Imprimir boleta</button>
                <a href="{% url 'home' %}" class="btn btn-secondary">Volver al inicio</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('btn-print')?.addEventListener('click', function(){
    // Obtener el HTML del comprobante y escribirlo en una ventana en blanco para imprimir
    var url = "{% url 'venta_comprobante' venta.id %}";
    fetch(url, { credentials: 'same-origin' }).then(function(resp){
        if(!resp.ok) throw new Error('network');
        return resp.text();
    }).then(function(html){
        // Limpiar scripts y controles de impresión del HTML para evitar que el comprobante vuelva a ofrecer imprimir
        var cleaned = html.replace(/<script[\s\S]*?<\/script>/gi, '');
        // Quitar el bloque que contiene el botón/anchor de impresión (clase no-print)
        cleaned = cleaned.replace(/<p[^>]*class=["']?no-print["']?[^>]*>[\s\S]*?<\/p>/gi, '');

        var w = window.open('', '_blank');
        if(!w){
            alert('No se pudo abrir la ventana de impresión. Compruebe el bloqueador de pop-ups.');
            return;
        }
        // Escribir el HTML limpio en la nueva ventana
        w.document.open();
        w.document.write(cleaned);
        w.document.close();
        try{ w.focus(); }catch(e){}

        // Forzar impresión y luego redirigir y cerrar
        try{
            // Intentar imprimir y luego redirigir el padre al home
            setTimeout(function(){
                try{ w.print(); }catch(e){ console.warn('print failed', e); }
                try{ window.location.href = "{% url 'home' %}"; }catch(e){}
                try{ w.close(); }catch(e){}
            }, 200);
        }catch(e){
            console.error(e);
            alert('Error al imprimir el comprobante.');
        }
    }).catch(function(err){
        console.error(err);
        alert('No se pudo cargar el comprobante para impresión.');
    });
});
</script>
{% endblock %}